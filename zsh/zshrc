# zmodload zsh/zprof && zprof

# ZSHRC_DIR=${$(readlink ${(%):-%x}):h}
# DOTFILES_DIR=${ZSHRC_DIR:h}
DOTFILES_DIR=$HOME/Repos/src/github.com/uetchy/dotfiles

# Antibody
source <(antibody init)
antibody bundle denysdovhan/spaceship-prompt
antibody bundle zsh-users/zsh-syntax-highlighting
antibody bundle zsh-users/zsh-completions
antibody bundle marzocchi/zsh-notify

# Spaceship
SPACESHIP_PROMPT_ORDER=(
  # time        # Time stampts section (Disabled)
  user # Username section
  dir # Current directory section
  host # Hostname section
  git # Git section (git_branch + git_status)
  # hg            # Mercurial section (hg_branch  + hg_status)
  package # Package version
  # node          # Node.js section
  ruby # Ruby section
  # elixir        # Elixir section
  xcode # Xcode section
  swift # Swift section
  # golang        # Go section
  # php           # PHP section
  rust # Rust section
  # haskell       # Haskell Stack section
  # julia       # Julia section (Disabled)
  # docker      # Docker section (Disabled)
  aws # Amazon Web Services section
  venv # virtualenv section
  # conda         # conda virtualenv section
  # pyenv         # Pyenv section
  # dotnet        # .NET section
  # ember       # Ember.js section (Disabled)
  # kubecontext   # Kubectl context section
  exec_time # Execution time
  line_sep # Line break
  battery # Battery level and status
  # vi_mode     # Vi-mode indicator (Disabled)
  jobs # Background jobs indicator
  exit_code # Exit code section
  char # Prompt character
)

# Notification
setopt notify
zstyle ':notify:*' command-complete-timeout 5

# no beep sound
setopt no_beep

# Colors
export CLICOLOR=true

# Completion
autoload -U compinit
compinit -u

# completion caches
zstyle ':completion:*' use-cache on

# Ignore completion for non-existant commands
zstyle ':completion:*:functions' ignored-patterns '_*'

# cd will never select the parent directory (e.g.: cd ../<TAB>):
zstyle ':completion:*:cd:*' ignore-parents parent pwd

# insensitive completion
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'

# Fuzzy completion
zstyle ':completion:*:approximate:*' max-errors 3 numeric

# ignore package-lock.json when completing
zstyle ':completion:*' file-patterns '^package-lock.json:source-files' '*:all-files'

# Language
export LANG="en_US.UTF-8"
export LC_ALL=$LANG

WORDCHARS='*?_-.[]~=&;!#$%^(){}<>'

# Key binding
bindkey -e

# History
HISTFILE="$HOME/.zsh_history"
HISTSIZE=1000
SAVEHIST=2000
setopt share_history
setopt hist_ignore_dups
setopt hist_ignore_space
setopt hist_reduce_blanks

# zsh
setopt nonomatch
setopt auto_cd
setopt correct
alias reload="source ~/.zshrc"
alias editrc="$EDITOR ~/.zshrc"

# vim
export EDITOR="vim"

# network settings
function restart_wifi() {
  sudo ifconfig en0 down
  sudo ifconfig en0 up
}

# Visual Studio Code
alias vs="code ."

# open
alias op="open ."

# rmtrash `brew install rmtrash`
alias trash="rmtrash"

# tree `brew install tree`
alias tree="tree -F -I node_modules"

# direnv `brew install direnv`
eval "$(direnv hook zsh)"

alias dea="direnv allow"

# autoenv
#source /usr/local/opt/autoenv/activate.sh

# du
alias volumestat="du -m -x -d 3 ~/Repos/src | awk '\$1 >= 500{print}'"

# ls
alias la="ls -la"
alias lt="ls -lt"

# Git
alias git="hub"
alias gt="gittower ."
alias st="git status"
alias gd="git diff"
alias recent="git recent"
alias pull="git pull --rebase"
alias push="git push -u origin master"
alias set-upstream="git branch --set-upstream-to=origin/master master"
alias stashall="git stash -u"
alias unstash="git stash pop"

add() {
  git add $1
  git status
}

# SSH
alias sak="ssh-add -K"

remote() {
  ssh $1 -t 'screen -qR'
}

forward() {
  ssh -L ${1}:localhost:${1} -N ${2}
}

alias forward-vnc="forward 5900"
alias forward-jupyter="forward 18888"

alias s="screen -qR"

# remote worker scripts
export WORKER=com

sk() {
  echo 🚀 Syncing to $WORKER
  rsync -C --filter=":- .gitignore" --exclude=".git*" -avz . ${WORKER}:jobs/$(basename $PWD)
}

receive() {
  echo 📞 Receiving \"$1\" on $WORKER
  rsync -C --exclude=".git*" -avz ${WORKER}:jobs/$(basename $PWD)/$1 ./$1
}

run() {
  echo 🏃 Running \"$@\" on $WORKER
  ssh -t $WORKER "cd jobs/$(basename $PWD); bash -ic \"$@\"" 2>/dev/null
}

skrun() {
  sk && echo '' && run $@
}

dive() {
  echo 🎯 Dive into jobs/$(basename $PWD) on $WORKER
  ssh -t $WORKER "cd jobs/$(basename $PWD); bash"
}

# iTerm2
test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"

# googler
alias g="googler"
alias goto="googler -j"

# Ruby
alias be="bundle exec"
alias bi="bundle install --without production:staging --path vendor/bundle --binstubs vendor/bundle/bin --jobs 4"

glar() {
  gem list --remote --all --pre "^${1}$"
}

# Python
alias pipreq="pip list --format=freeze --not-required > requirements.txt"
alias pe="pipenv"
export PIPENV_VENV_IN_PROJECT=1

mkvenv() {
  pipenv install --three
  echo 'layout_pipenv' >>.envrc
  direnv allow
}

mkvenv2() {
  pipenv install --two
  echo 'layout_pipenv' >>.envrc
  direnv allow
}

pip-update() {
  pip2 list --outdated --format=json | jq '.[].name' | xargs pip2 install -U
  pip3 list --outdated --format=json | jq '.[].name' | xargs pip3 install -U
}


# Homebrew Cask
cask-update() {
  brew cask outdated | awk '{print $1}' | xargs brew cask reinstall
}

# Juno
juno() {
  open -a Juno $1
}

# Node
export PATH="/usr/local/lib/node_modules:$PATH"
alias npm-list="npm list -g --depth 0"
alias yui="yarn upgrade-interactive"
alias np-precheck="f=\$(npm pack);tar -tf \$f; rm \$f"

# Go
export GOPATH="$HOME/Repos"
export PATH=$PATH:$GOPATH/bin

# Rust
if [ -f $HOME/.cargo ]; then source $HOME/.cargo/env; fi

# CUDA
#export CUDA_HOME=/Developer/NVIDIA/CUDA-9.0
#export PATH="$CUDA_HOME/bin:$PATH"
#export DYLD_LIBRARY_PATH="$CUDA_HOME/lib:$DYLD_LIBRARY_PATH"

# Google Cloud Platform
source '/usr/local/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/path.zsh.inc'
source '/usr/local/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/completion.zsh.inc'

# Docker
alias d="docker"
alias da="docker ps -a"
alias di="docker images"
alias dip="docker inspect \$(docker ps -lq) | grep IPAddress | cut -d '\"' -f 4"
alias drm="docker ps -aqf status=exited | xargs docker rm -v"
alias drmi="docker images -qf dangling=true | xargs docker rmi"

alias dc="docker-compose"
alias dm="docker-machine"

docker-tags() {
  curl -s https://registry.hub.docker.com/v2/repositories/$1/tags/ | jq -r '."results"[]["name"]'
}

# travis
[ -f ~/.travis/travis.sh ] && source ~/.travis/travis.sh

# ghq
alias get="ghq get"

# peco
function peco-src() {
  local selected_dir=$(ghq list | peco --query "$LBUFFER")
  if [ -n "$selected_dir" ]; then
    BUFFER="cd \"$(ghq root)/${selected_dir}\" && clear"
    zle accept-line
  fi
  zle redisplay
}
zle -N peco-src
bindkey '^r' peco-src

function peco-select-history() {
  BUFFER=$(fc -l -n 1 | tail -r | awk '!a[$0]++' | peco --query "$LBUFFER")
  CURSOR=$#BUFFER
  zle redisplay
}
zle -N peco-select-history
bindkey '^h' peco-select-history

_peco_mdfind() {
  result=$(mdfind -onlyin ~ "kMDItemKind==\"Folder\"&&kMDItemFSName==\"*$@*\"cd" | grep -v "node_modules" | peco)
  if [ -n "$result" ]; then
    cd $result
    clear
  fi
}
alias forage="_peco_mdfind"

# YouTube
ydl() {
  youtube-dl "$1" -f mp4 --add-metadata
}

ydl_audio() {
  youtube-dl "$1" -x --audio-format=mp3 --embed-thumbnail --add-metadata
}

update() {
  pushd $DOTFILES_DIR && git pull && popd
  reload
  HOMEBREW_INSTALL_CLEANUP=1 brew upgrade
  pip-update
  cask-update
  mas upgrade
  npm i -g npm
  david -gu
}

clearCache() {
  npm cache verify
  gem cleanup
  brew cleanup
  brew prune
  brew doctor
}

clearQLCache() {
  qlmanage -r
  qlmanage -r cache
}

gu() {
  gtPrivateKeyPath=$(git config remote.origin.gtPrivateKeyPath)
  privateKeyPath=${gtPrivateKeyPath:-~/.ssh/id_rsa}
  gitUser=$(git config user.name)
  gitEmail=$(git config user.email)
  echo "Name: ${gitUser}"
  echo "Mail: ${gitEmail}"
  echo "Private: ${privateKeyPath}"
  echo ""
  GIT_SSH_COMMAND="ssh -i ${privateKeyPath} -oIdentitiesOnly=yes" $@
}

# Chromium
#chromium-path() {
#  export PATH="$PATH:$HOME/Repos/src/chromium.googlesource.com/chromium/tools/depot_tools"
#}

# OCaml
#test -r $HOME/.opam/opam-init/init.zsh && . $HOME/.opam/opam-init/init.zsh >/dev/null 2>/dev/null || true

#zprof
